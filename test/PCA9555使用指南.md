# PCA9555/TCA9555 GPIOæ‰©å±•å™¨ä½¿ç”¨æŒ‡å—

## ğŸ“‹ èŠ¯ç‰‡ç‰¹æ€§

- **16ä½I2C GPIOæ‰©å±•å™¨**
- **åŒ8ä½ç«¯å£**: Port 0 (P0.0-P0.7) + Port 1 (P1.0-P1.7)
- **I2Cåœ°å€**: å¯é…ç½® 0x20-0x27 (é€šè¿‡A0/A1/A2å¼•è„š)
- **å·¥ä½œç”µå‹**: 2.3V - 5.5V
- **æœ€å¤§ç”µæµ**: æ¯ä¸ªå¼•è„š25mAï¼Œæ€»å’Œ400mA
- **I2Cé€Ÿåº¦**: æœ€é«˜400kHz (Fast Mode)

## ğŸ”Œ ç¡¬ä»¶è¿æ¥

### åŸºæœ¬è¿æ¥
```
PCA9555          ESP32-PICO-D4
--------         --------------
VCC      ->      3.3V
GND      ->      GND
SDA      ->      GPIO 21 (I2C_SDA)
SCL      ->      GPIO 22 (I2C_SCL)
A0       ->      GND  â”
A1       ->      GND  â”œâ”€> I2Cåœ°å€ = 0x20
A2       ->      GND  â”˜
```

### I2Cåœ°å€é…ç½®
| A2 | A1 | A0 | åœ°å€   |
|----|----|----|--------|
| 0  | 0  | 0  | 0x20   |
| 0  | 0  | 1  | 0x21   |
| 0  | 1  | 0  | 0x22   |
| 0  | 1  | 1  | 0x23   |
| 1  | 0  | 0  | 0x24   |
| 1  | 0  | 1  | 0x25   |
| 1  | 1  | 0  | 0x26   |
| 1  | 1  | 1  | 0x27   |

### SPIç‰‡é€‰æ‰©å±•è¿æ¥
```
PCA9555 å¼•è„š         ç”¨é€”
---------------     --------
P0.0 (Pin 4)   ->   SPI_CS0
P0.1 (Pin 5)   ->   SPI_CS1
P0.2 (Pin 6)   ->   SPI_CS2
P0.3 (Pin 7)   ->   SPI_CS3
P0.4 (Pin 8)   ->   SPI_CS4
P0.5 (Pin 9)   ->   SPI_CS5
P0.6 (Pin 10)  ->   SPI_CS6
P0.7 (Pin 11)  ->   SPI_CS7
P1.0 (Pin 12)  ->   SPI_CS8
P1.1 (Pin 13)  ->   SPI_CS9
P1.2 (Pin 14)  ->   SPI_CS10
P1.3 (Pin 15)  ->   SPI_CS11
P1.4 (Pin 16)  ->   SPI_CS12
P1.5 (Pin 17)  ->   SPI_CS13
P1.6 (Pin 18)  ->   SPI_CS14
P1.7 (Pin 19)  ->   SPI_CS15
```

## ğŸ“š åº“å‡½æ•°å‚è€ƒ

### åˆå§‹åŒ–
```cpp
#include <TCA9555.h>

TCA9555 gpio(0x20);  // åˆ›å»ºå¯¹è±¡ï¼ŒæŒ‡å®šI2Cåœ°å€

void setup() {
    Wire.begin(21, 22);     // SDA=21, SCL=22
    Wire.setClock(400000);  // 400kHz
    
    if (!gpio.begin()) {
        Serial.println("åˆå§‹åŒ–å¤±è´¥ï¼");
    }
}
```

### å¼•è„šé…ç½®
```cpp
// å•ä¸ªå¼•è„šé…ç½®ä¸ºè¾“å‡º
gpio.pinMode(0, OUTPUT);

// å•ä¸ªå¼•è„šé…ç½®ä¸ºè¾“å…¥
gpio.pinMode(15, INPUT);

// æ‰¹é‡é…ç½®Port 0æ‰€æœ‰å¼•è„šä¸ºè¾“å‡º
gpio.pinMode8(0, 0x00);  // 0x00 = æ‰€æœ‰è¾“å‡º, 0xFF = æ‰€æœ‰è¾“å…¥
```

### æ•°å­—å†™å…¥
```cpp
// å•ä¸ªå¼•è„šå†™å…¥
gpio.digitalWrite(0, HIGH);
gpio.digitalWrite(5, LOW);

// æ‰¹é‡å†™å…¥Port 0 (8ä¸ªå¼•è„š)
gpio.write8(0, 0xFF);    // æ‰€æœ‰å¼•è„šç½®é«˜
gpio.write8(0, 0x00);    // æ‰€æœ‰å¼•è„šç½®ä½
gpio.write8(0, 0xAA);    // 0b10101010 å¥‡æ•°é«˜å¶æ•°ä½

// æ‰¹é‡å†™å…¥Port 1 (8ä¸ªå¼•è„š)
gpio.write8(1, 0xFF);

// æ‰¹é‡å†™å…¥å…¨éƒ¨16å¼•è„š
gpio.write16(0xFFFF);    // æ‰€æœ‰å¼•è„šç½®é«˜
gpio.write16(0x0000);    // æ‰€æœ‰å¼•è„šç½®ä½
```

### æ•°å­—è¯»å–
```cpp
// å•ä¸ªå¼•è„šè¯»å–
bool state = gpio.digitalRead(7);

// æ‰¹é‡è¯»å–Port 0
uint8_t port0_state = gpio.read8(0);

// æ‰¹é‡è¯»å–Port 1
uint8_t port1_state = gpio.read8(1);

// æ‰¹é‡è¯»å–å…¨éƒ¨16å¼•è„š
uint16_t all_pins = gpio.read16();
```

### å¼•è„šç¿»è½¬
```cpp
// ç¿»è½¬å•ä¸ªå¼•è„š
gpio.toggle(3);

// ç¿»è½¬Port 0æ‰€æœ‰å¼•è„š
gpio.toggle8(0);
```

## ğŸ’¡ å®ç”¨ä»£ç ç‰‡æ®µ

### ç‰‡æ®µ1: SPIç‰‡é€‰ç®¡ç†ç±»
```cpp
class CS_Manager {
private:
    TCA9555* expander;
    
public:
    CS_Manager(TCA9555* exp) : expander(exp) {
        // åˆå§‹åŒ–æ‰€æœ‰CSä¸ºè¾“å‡ºä¸”ç½®é«˜
        for (int i = 0; i < 16; i++) {
            expander->pinMode(i, OUTPUT);
            expander->digitalWrite(i, HIGH);
        }
    }
    
    void select(uint8_t cs) {
        expander->digitalWrite(cs, LOW);
    }
    
    void deselect(uint8_t cs) {
        expander->digitalWrite(cs, HIGH);
    }
    
    void deselectAll() {
        expander->write16(0xFFFF);
    }
};
```

### ç‰‡æ®µ2: å¿«é€Ÿæ‰¹é‡æ“ä½œ
```cpp
// ä¸€æ¬¡æ€§é€‰ä¸­å¤šä¸ªè®¾å¤‡ (CS0, CS2, CS4, CS6)
// ä½æ©ç : ~0b01010101 = 0xAA
gpio.write8(0, 0xAA);

// ä»…é€‰ä¸­CS3
gpio.write8(0, 0xFF & ~(1 << 3));

// ä½¿ç”¨ä½æ“ä½œè®¾ç½®ç‰¹å®šå¼•è„š
uint8_t mask = (1 << 2) | (1 << 5);  // CS2å’ŒCS5
gpio.write8(0, 0xFF & ~mask);
```

### ç‰‡æ®µ3: ä¸­æ–­æ£€æµ‹ï¼ˆå¯é€‰ï¼‰
```cpp
// PCA9555æœ‰INTå¼•è„šï¼Œå¯æ£€æµ‹è¾“å…¥å˜åŒ–
#define INT_PIN 4

void setup() {
    pinMode(INT_PIN, INPUT_PULLUP);
    attachInterrupt(INT_PIN, handleGpioInterrupt, FALLING);
}

void handleGpioInterrupt() {
    // è¯»å–å“ªäº›å¼•è„šè§¦å‘äº†ä¸­æ–­
    uint16_t state = gpio.read16();
    // å¤„ç†å˜åŒ–...
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨æ‰¹é‡æ“ä½œ
```cpp
// âŒ æ…¢ï¼šé€ä¸ªè®¾ç½®
for (int i = 0; i < 8; i++) {
    gpio.digitalWrite(i, LOW);  // 8æ¬¡I2Cä¼ è¾“
}

// âœ… å¿«ï¼šæ‰¹é‡è®¾ç½®
gpio.write8(0, 0x00);  // 1æ¬¡I2Cä¼ è¾“
```

### 2. å‡å°‘I2Cé€šä¿¡
```cpp
// ç¼“å­˜å½“å‰çŠ¶æ€ï¼Œé¿å…ä¸å¿…è¦çš„å†™å…¥
uint8_t current_state = 0xFF;

void setCS(uint8_t cs, bool active) {
    uint8_t new_state = active ? 
        (current_state & ~(1 << cs)) : 
        (current_state | (1 << cs));
    
    if (new_state != current_state) {
        gpio.write8(0, new_state);
        current_state = new_state;
    }
}
```

### 3. I2Cé€Ÿåº¦ä¼˜åŒ–
```cpp
// ä½¿ç”¨Fast Mode (400kHz)
Wire.setClock(400000);

// å¦‚æœè·ç¦»çŸ­ä¸”ç¨³å®šï¼Œå¯å°è¯•Fast Mode Plus (1MHz)
Wire.setClock(1000000);
```

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: è®¾å¤‡æ— å“åº”
```cpp
// æ£€æŸ¥I2Cæ‰«æ
void scanI2C() {
    for (uint8_t addr = 1; addr < 127; addr++) {
        Wire.beginTransmission(addr);
        if (Wire.endTransmission() == 0) {
            Serial.printf("å‘ç°I2Cè®¾å¤‡: 0x%02X\n", addr);
        }
    }
}
```

### é—®é¢˜2: ç‰‡é€‰ä¸å·¥ä½œ
```cpp
// éªŒè¯å¼•è„šçŠ¶æ€
void verifyPins() {
    gpio.write8(0, 0x00);  // å…¨éƒ¨æ‹‰ä½
    delay(100);
    uint8_t state = gpio.read8(0);
    if (state != 0x00) {
        Serial.println("è­¦å‘Šï¼šå¼•è„šçŠ¶æ€ä¸åŒ¹é…ï¼");
    }
}
```

### é—®é¢˜3: ç”µæµä¸è¶³
- æ£€æŸ¥æ€»ç”µæµæ˜¯å¦è¶…è¿‡400mAé™åˆ¶
- é«˜åŠŸè€—è®¾å¤‡ä½¿ç”¨å¤–éƒ¨é©±åŠ¨å™¨ï¼ˆå¦‚74HC244ï¼‰

## ğŸ“ é¡¹ç›®é›†æˆæ­¥éª¤

1. **æ·»åŠ åº“ä¾èµ–** (platformio.ini)
```ini
lib_deps = 
    robtillaart/TCA9555@^0.4.4
```

2. **åŒ…å«å¤´æ–‡ä»¶**
```cpp
#include <Wire.h>
#include <TCA9555.h>
```

3. **åˆå§‹åŒ–**
```cpp
TCA9555 gpio(0x20);
Wire.begin(21, 22);
gpio.begin();
```

4. **ä½¿ç”¨**
```cpp
gpio.pinMode(0, OUTPUT);
gpio.digitalWrite(0, HIGH);
```

## ğŸ¯ åº”ç”¨åœºæ™¯

- âœ… æ‰©å±•16ä¸ªSPIè®¾å¤‡ç‰‡é€‰
- âœ… å¤šè·¯LEDæ§åˆ¶
- âœ… æŒ‰é”®çŸ©é˜µè¾“å…¥
- âœ… ç»§ç”µå™¨æ§åˆ¶æ¿
- âœ… å¤šæ˜¾ç¤ºå±é©±åŠ¨
- âœ… å¤šä¼ æ„Ÿå™¨è¯»å–

## ğŸ“– å‚è€ƒèµ„æº

- [TCA9555æ•°æ®æ‰‹å†Œ](https://www.ti.com/lit/ds/symlink/tca9555.pdf)
- [PCA9555æ•°æ®æ‰‹å†Œ](https://www.nxp.com/docs/en/data-sheet/PCA9555.pdf)
- [Arduinoåº“æ–‡æ¡£](https://github.com/RobTillaart/TCA9555)
