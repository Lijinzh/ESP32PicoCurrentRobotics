# ESP32 Pico 多编码器高速通信系统

基于ESP32-PICO-D4的高性能Modbus RTU多编码器数据采集系统。采用批量快速处理模式，实现了高频率、低延迟的多路编码器数据读取。

## 📋 项目简介

本项目实现了通过RS485总线与多个Modbus编码器的高速通信，优化了数据采集流程，绕过了传统库的开销，通过紧凑的发送-接收循环实现了最高频率的数据更新。

### ✨ 主要特性

- 🚀 **高速通信**: 115200波特率，支持100+Hz的数据更新频率
- 📡 **多编码器支持**: 同时读取多个Modbus RTU编码器（当前配置4个）
- 🎯 **批量处理模式**: 优化的批量读取流程，最小化通信延迟
- 💡 **状态指示**: WS2812 LED实时显示通信状态
- 🔊 **声音反馈**: 蜂鸣器启动提示音
- 📊 **CSV数据输出**: 实时输出角度数据，便于数据分析

## 🔧 硬件配置

### 开发板
- **主控芯片**: ESP32-PICO-D4
- **CPU频率**: 240MHz
- **Flash频率**: 80MHz

### 引脚分配

| 功能 | 引脚 | 说明 |
|------|------|------|
| RS485 RX | GPIO 32 | 接收数据 |
| RS485 TX | GPIO 33 | 发送数据 |
| RS485 DE/RE | GPIO 25 | 收发控制 |
| WS2812 LED | GPIO 26 | 状态指示灯 |
| 蜂鸣器 | GPIO 2 | 声音提示 |

### 编码器配置
- **通信协议**: Modbus RTU
- **波特率**: 115200
- **数据位**: 8N1
- **设备地址**: 1, 2, 3, 5（可在代码中修改）
- **读取寄存器**: 地址 0x0001（角度数据）

## 📦 依赖库

```ini
- emelianov/modbus-esp8266 @ ^4.1.0
- fastled/FastLED @ ^3.10.3
```

## 🚀 快速开始

### 环境准备

1. 安装 [PlatformIO](https://platformio.org/)
2. 克隆本仓库：
   ```bash
   git clone https://github.com/your-username/ESP32PicoCurrentRobotics.git
   cd ESP32PicoCurrentRobotics
   ```

### 编译与上传

```bash
# 编译项目
pio run

# 上传到开发板
pio run --target upload

# 打开串口监视器
pio device monitor
```

### 配置说明

在 `src/main.cpp` 中可以修改以下参数：

```cpp
// 编码器数量
#define NUM_ENCODERS 4

// 编码器Modbus地址
const uint8_t ENCODER_IDS[NUM_ENCODERS] = {1, 2, 3, 5};

// 数据输出间隔（毫秒）
// 当前为10ms，即100Hz输出频率
if (millis() - last_output_time >= 10) {
    // ...
}
```

## 📊 数据格式

### 串口输出

程序通过串口输出CSV格式的角度数据：

```
180.25,90.13,270.87,45.62
181.30,90.15,271.00,45.70
...
```

每行包含所有编码器的角度值（单位：度），范围 0-360°。

### LED状态指示

- 🟠 **橙色**: 系统初始化中
- 🔵 **蓝色**: 系统就绪
- 🟢 **绿色**: 所有编码器通信正常
- 🔴 **红色**: 至少一个编码器通信异常

## ⚡ 性能优化

本项目采用了多项优化措施以实现最高通信频率：

1. **预生成Modbus帧**: 启动时生成所有请求帧，避免运行时开销
2. **阻塞式读取**: 使用紧凑的发送-接收循环，消除异步等待延迟
3. **最小化超时**: Serial超时设置为5ms，快速检测通信失败
4. **硬件加速**: CPU 240MHz + QIO Flash模式
5. **高速烧录**: 2Mbps上传速度，快速迭代开发

## 🛠️ 故障排查

### 通信失败（LED显示红色）

1. 检查RS485接线是否正确
2. 确认编码器波特率为115200
3. 验证编码器Modbus地址与代码中配置一致
4. 检查RS485总线终端电阻

### 数据更新频率低

1. 减少编码器数量
2. 调整数据输出间隔
3. 检查串口是否有大量输出（降低Serial输出频率）

## 📝 许可证

本项目采用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系方式

如有问题或建议，请通过 GitHub Issues 联系。

---

**注意**: 本项目为机器人控制系统的一部分，请确保在安全环境下测试和使用。
